<?php
// archivo: procesar_login.php
session_start();
include_once 'conexion.php';

// Obtener los datos del formulario y sanitizarlos
$username = filter_input(INPUT_POST, 'username', FILTER_SANITIZE_STRING);
$password = filter_input(INPUT_POST, 'password', FILTER_SANITIZE_STRING);

// Verificar que los datos del formulario no estén vacíos
if (empty($username) || empty($password)) {
    $_SESSION['error_message'] = "Por favor ingrese nombre de usuario y contraseña.";
    header("Location: login.php");
    exit();
}

// Consultar si el usuario existe
$sql = "SELECT * FROM usuarios WHERE username = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("s", $username);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows > 0) {
    // Usuario encontrado, verificar la contraseña
    $user = $result->fetch_assoc();
    
    if (password_verify($password, $user['password'])) {
        // Contraseña correcta, iniciar sesión
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['fullname'] = $user['fullname'];

        // Registrar el inicio de sesión exitoso en la auditoría
        $sql = "INSERT INTO auditoria_sesiones (usuario_id, fecha_hora, tipo_intento, ip_address) 
                VALUES (?, NOW(), 'exitoso', ?)";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("is", $user['id'], $_SERVER['REMOTE_ADDR']);
        $stmt->execute();

        header("Location: index.php"); // Redirigir al formulario principal
        exit();
    } else {
        // Contraseña incorrecta
        $_SESSION['error_message'] = "Nombre de usuario o contraseña incorrectos.";

        // Registrar el intento fallido en la auditoría
        $sql = "INSERT INTO auditoria_sesiones (usuario_id, fecha_hora, tipo_intento, ip_address, motivo_error) 
                VALUES (?, NOW(), 'fallido', ?, 'Contraseña incorrecta')";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("iss", $user['id'], $_SERVER['REMOTE_ADDR'], $_SESSION['error_message']);
        $stmt->execute();
        
        header("Location: login.php"); // Redirigir al formulario de login
        exit();
    }
} else {
    // Usuario no encontrado
    $_SESSION['error_message'] = "Nombre de usuario o contraseña incorrectos.";

    // Registrar el intento fallido en la auditoría
    $sql = "INSERT INTO auditoria_sesiones (usuario_id, fecha_hora, tipo_intento, ip_address, motivo_error) 
            VALUES (NULL, NOW(), 'fallido', ?, 'Usuario no encontrado')";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("s", $_SERVER['REMOTE_ADDR']);
    $stmt->execute();

    header("Location: login.php"); // Redirigir al formulario de login
    exit();
}

$conn->close();
?>
